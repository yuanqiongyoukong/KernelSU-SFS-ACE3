name: è¶…é«˜é€Ÿå†…æ ¸æ„å»º - 2025ä¼˜åŒ–ç‰ˆ 
on:
  workflow_dispatch:
    inputs:
      KSU: 
        description: "å¯ç”¨ KernelSU"
        required: true 
        type: boolean 
        default: true 
      KSU_VERSION:
        description: "KernelSU ç‰ˆæœ¬"
        required: true 
        type: choice 
        options: [ksu, mksu, rksu]
      BRANCH_CONFIG:
        description: "åˆ†æ”¯é…ç½®"
        required: false 
        type: choice 
        options: [tag, main]
      SUSFS: 
        description: "å¯ç”¨ SUSFS"
        required: true 
        type: boolean
        default: true 
      HIDE: 
        description: "å¯ç”¨éšè—è¡¥ä¸"
        required: true 
        type: boolean 
        default: true 
      VFS: 
        description: "å¯ç”¨æ‰‹åŠ¨é’©å­"
        required: true 
        type: boolean 
        default: true 
      KERNEL_NAME:
        description: "è‡ªå®šä¹‰å†…æ ¸å"
        required: false 
        default: ''
 
env:
  CPU: sm8550
  FEIL: oneplus_ace3_v 
  CPUD: kalama
  ANDROID_VERSION: android13 
  KERNEL_VERSION: 5.15
  SSD_CACHE: /mnt/ssd-cache  # SSDåŠ é€Ÿç¼“å­˜è·¯å¾„ 
 
jobs:
  prepare:
    runs-on: ubuntu-latest 
    outputs:
      ksu_version: ${{ steps.set-ksu.outputs.KSUVER  }}
    steps:
    - name:  æŒ‚è½½SSDåŠ é€Ÿç›˜ 
      run: |
        sudo mkdir -p ${{ env.SSD_CACHE }}
        sudo mount -t tmpfs -o size=8G tmpfs ${{ env.SSD_CACHE }}
        echo "GIT_TEMPLATE_DIR=${{ env.SSD_CACHE }}/git-template" >> $GITHUB_ENV
        mkdir -p ${{ env.SSD_CACHE }}/git-template/hooks
        
    - name: ğŸ” æ™ºèƒ½ç¼“å­˜.repo
      id: repo-cache 
      uses: actions/cache@v3 
      with:
        path: |
          kernel_workspace/.repo
          kernel_workspace/kernelsu_patch
        key: ${{ runner.os  }}-repo-${{ env.CPU }}-${{ hashFiles('.github/kernel_versions') }}-${{ inputs.KSU_VERSION }}
        restore-keys: |
          ${{ runner.os  }}-repo-${{ env.CPU }}-
          
    - name:  æé€Ÿåˆå§‹åŒ– 
      run: |
        # SSDåŠ é€Ÿé…ç½® 
        git config --global uploadpack.allowFilter  true 
        git config --global core.preloadIndex  true
        git config --global core.fscache  true 
        git config --global pack.threads  $(nproc)
        
        # åŸºç¡€ç¯å¢ƒ
        sudo apt install -y python3 git-core curl make gcc binutils --no-install-recommends 
        
        # ä»…å½“ç¼“å­˜æœªå‘½ä¸­æ—¶åˆå§‹åŒ–
        if [[ ! -f /usr/local/bin/repo ]]; then
          curl -Lo /usr/local/bin/repo https://mirror.iscas.ac.cn/git-repo/repo 
          chmod a+x /usr/local/bin/repo
        fi 
 
    - name: ğŸ“¥ å¢é‡åŒæ­¥å†…æ ¸ 
      run: |
        mkdir -p kernel_workspace 
        cd kernel_workspace
        
        # æ™ºèƒ½å¢é‡åŒæ­¥
        repo init -u https://mirror.iscas.ac.cn/AOSP/kernel/manifest  \
          -b refs/heads/oneplus/${CPU} \
          -m ${FEIL}.xml \
          --depth=1 \
          --repo-url=https://mirror.iscas.ac.cn/git-repo  
        
        repo sync -c -j$(nproc) \
          --no-tags \
          --no-clone-bundle \
          --optimized-fetch \
          --prune \
          --force-sync
        
        # æŒ‰éœ€å…‹éš†ç»„ä»¶
        if [[ ! -d AnyKernel3 && '${{ inputs.KSU }}' == 'true' ]]; then 
          git clone https://ghproxy.com/https://github.com/Kernel-SU/AnyKernel3  --depth=1
        fi 
        
    - name:  âš™ï¸ è®¾ç½® KernelSU
      id: set-ksu
      if: ${{ inputs.KSU == 'true' }}
      run: |
        cd kernel_workspace/kernel_platform
        
        # åŠ¨æ€åˆ†æ”¯é€‰æ‹©
        case "${{ inputs.KSU_VERSION }}" in
          ksu) branch="${{ inputs.BRANCH_CONFIG == 'tag' && '' || '-s main' }}" ;;
          mksu) branch="" ;;
          rksu) branch="${{ inputs.SUSFS == 'true' && '-s susfs-v1.5.7' || '-s main' }}" ;;
        esac 
        
        # äº‘ç«¯æ‰§è¡Œé¿å…æœ¬åœ°å¼€é”€ 
        curl -LSs "https://kernelsu.cc/setup.sh"  | bash ${branch}
        
        # ç‰ˆæœ¬å·ç”Ÿæˆ 
        cd KernelSU
        KSUVER=$(expr $(git rev-list --count HEAD) + 10200)
        sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSUVER}/" kernel/Makefile 
        
        # è¾“å‡ºç»“æœ
        echo "KSUVER=${KSUVER}" >> $GITHUB_OUTPUT 
        echo "KSUVER=${KSUVER}" >> $GITHUB_ENV
 
  build:
    needs: prepare
    runs-on: ubuntu-latest 
    env:
      BUILD_THREADS: ${{ matrix.threads  }}
    strategy:
      matrix:
        threads: [16, 32]  # åŠ¨æ€çº¿ç¨‹åˆ†é… 
        
    steps:
    - name:  ğŸ”„ ç»§æ‰¿SSDç¼“å­˜ 
      run: |
        sudo mkdir -p ${{ env.SSD_CACHE }}
        sudo mount -t tmpfs -o size=8G tmpfs ${{ env.SSD_CACHE }}
        echo "GIT_TEMPLATE_DIR=${{ env.SSD_CACHE }}/git-template" >> $GITHUB_ENV 
        
    - name:  ğŸ“¦ æŒ‰éœ€åŠ è½½SUSFS 
      if: ${{ inputs.SUSFS == 'true' }}
      run: |
        cd kernel_workspace
        if [ ! -d "susfs4ksu" ]; then
          git clone https://gitlab.com/simonpunk/susfs4ksu.git  \
            -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }} \
            --depth 1 \
            --single-branch
        fi 
        
    - name:  âš¡ å¹¶è¡Œåº”ç”¨è¡¥ä¸ 
      run: |
        cd kernel_workspace/kernel_platform
        declare -A patch_map=(
          [susfs]="${{ inputs.SUSFS == 'true' }}"
          [hide]="${{ inputs.HIDE == 'true' }}"
          [vfs]="${{ inputs.VFS == 'true' }}"
        )
        
        # å¹¶è¡Œè¡¥ä¸å¼•æ“ 
        for patch_type in "${!patch_map[@]}"; do 
          if [[ "${patch_map[$patch_type]}" == "true" ]]; then 
            (
              source ${GITHUB_WORKSPACE}/.github/patch_${patch_type}.sh
            ) &
          fi 
        done
        wait  # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡
        
    - name:  ğŸ”§ åŠ¨æ€ç”Ÿæˆé…ç½®
      shell: bash 
      run: |
        cd kernel_workspace/kernel_platform
        python3 <<EOF 
        import os 
        config_path = "common/arch/arm64/configs/gki_defconfig"
        
        with open(config_path, "a") as f:
          f.write("\n#  ===== åŠ¨æ€é…ç½® =====\n")
          if "${{ inputs.KSU }}" == "true":
            f.write("CONFIG_KSU=y\n") 
          
          # SUSFSé…ç½®é€»è¾‘ 
          if "${{ inputs.SUSFS }}" == "true":
            f.write("CONFIG_KSU_SUSFS=y\n") 
            if "${{ inputs.VFS }}" == "true":
              f.write("CONFIG_KSU_SUSFS_SUS_SU=n\n") 
            else:
              f.write("CONFIG_KPROBES=y\nCONFIG_KSU_SUSFS_SUS_SU=y\n") 
            
            # ç‰ˆæœ¬ç‰¹å®šé…ç½®
            if "${{ inputs.KSU_VERSION }}" == "ksu":
              f.write("CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y\n") 
            else:
              f.write("CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n\n") 
            
            # é€šç”¨SUSFSé…ç½® 
            susfs_configs = [
              "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT",
              "CONFIG_KSU_SUSFS_SUS_PATH",
              "CONFIG_KSU_SUSFS_SUS_MOUNT",
              "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT",
              "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT",
              "CONFIG_KSU_SUSFS_SUS_KSTAT",
              "CONFIG_KSU_SUSFS_TRY_UMOUNT",
              "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT",
              "CONFIG_KSU_SUSFS_SPOOF_UNAME",
              "CONFIG_KSU_SUSFS_ENABLE_LOG",
              "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS",
              "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG",
              "CONFIG_KSU_SUSFS_OPEN_REDIRECT"
            ]
            f.write("\n".join(susfs_configs)  + "\n")
        EOF
        
    - name:  ğŸ—ï¸ å¹¶è¡Œç¼–è¯‘å†…æ ¸
      timeout-minutes: 25 
      run: |
        cd kernel_workspace
        # åŠ¨æ€çº¿ç¨‹åˆ†é… 
        THREADS=$(( (${BUILD_THREADS} > $(nproc)) ? $(nproc) : ${BUILD_THREADS} ))
        
        # å¢é‡ç¼–è¯‘æ¨¡å¼ 
        LTO=thin \
        SYSTEM_DLKM_RE_SIGN=0 \
        BUILD_SYSTEM_DLKM=0 \
        KMI_SYMBOL_LIST_STRICT_MODE=0 \
        KERNEL_MODULES_SYNC=n \
        ./kernel_platform/oplus/build/oplus_build_kernel.sh  ${CPUD} gki -j${THREADS}
        
    - name:  ğŸ“¦ æ™ºèƒ½æ‰“åŒ…AnyKernel 
      run: |
        cd kernel_workspace 
        mkdir -p artifact 
        
        # åŠ¨æ€ç”Ÿæˆæ–‡ä»¶å 
        FEIL_CLEAN=${FEIL%_v}
        FEIL_CLEAN=${FEIL_CLEAN%_u}
        VFS_FLAG=${{ inputs.VFS && '_VFS' || '' }}
        TIMESTAMP=$(date +"%Y%m%d-%H%M")
        
        # ç§»åŠ¨å†…æ ¸æ˜ åƒ 
        cp kernel_platform/out/msm-kernel-${CPUD}-gki/gki_kernel/dist/Image AnyKernel3/
        
        # ç”Ÿæˆå…ƒæ•°æ®
        echo "KSU_VERSION=${{ inputs.KSU_VERSION }}" > AnyKernel3/build.info  
        echo "KSU_VER=${{ needs.prepare.outputs.ksu_version  }}" >> AnyKernel3/build.info  
        echo "BUILD_TIME=${TIMESTAMP}" >> AnyKernel3/build.info  
        
        # åˆ›å»ºå‹ç¼©åŒ…
        zip -r0 artifact/AnyKernel3_${FEIL_CLEAN}_${TIMESTAMP}.zip AnyKernel3/*
        
    - name:  ğŸš¢ é«˜é€Ÿä¸Šä¼ æˆå“ 
      uses: actions/upload-artifact@v4 
      with:
        name: Kernel_${{ inputs.KSU_VERSION }}_${{ needs.prepare.outputs.ksu_version  }}_${{ env.FEIL }}
        path: kernel_workspace/artifact/*.zip 
        compression-level: 0  # ç¦ç”¨å‹ç¼© 
        retention-days: 7 
